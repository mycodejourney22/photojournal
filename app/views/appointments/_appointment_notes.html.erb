<!-- app/views/appointments/_appointment_notes.html.erb -->
<div class="appointment-notes-section">
  <h5> Internal Notes & Instructions</h5>
  <small class="text-muted">These notes are only visible to staff members</small>
  
  <!-- Add New Note Form -->
  <div class="add-note-form mb-4 mt-3">
    <%= form_with model: [@appointment, @appointment_note], 
                  url: add_note_appointment_path(@appointment), 
                  local: true, 
                  class: "card p-3" do |form| %>
      
      <div class="row">
        <div class="col-md-6">
          <%= form.label :note_type, "Note Type", class: "form-label" %>
          <%= form.select :note_type, 
                          options_for_select(AppointmentNote::NOTE_TYPES.map { |k,v| [v,k] }), 
                          { prompt: "Select note type" }, 
                          { class: "form-select" } %>
        </div>
        
        <div class="col-md-6">
          <%= form.label :priority, "Priority", class: "form-label" %>
          <%= form.select :priority, 
                          options_for_select(AppointmentNote::PRIORITY_LABELS.map { |k,v| [v,k] }), 
                          {}, 
                          { class: "form-select" } %>
        </div>
      </div>
      
      <div class="mt-3">
        <%= form.label :title, "Title (Optional)", class: "form-label" %>
        <%= form.text_field :title, class: "form-control", placeholder: "Brief title for this note" %>
      </div>
      
      <div class="mt-3">
        <%= form.label :content, "Note Content", class: "form-label" %>
        <%= form.text_area :content, rows: 3, class: "form-control", 
                           placeholder: "Enter your instructions or notes here..." %>
      </div>
      
      <div class="mt-3">
        <%= form.submit "Add Internal Note", class: "g-button g-button--action" %>
      </div>
    <% end %>
  </div>
  
  <!-- Display Existing Notes -->
  <div class="existing-notes">
    <% if @appointment.has_notes? %>
      <% @notes_by_type.each do |note_type, notes| %>
        <div class="note-type-section mb-4">
          <h5 class="note-type-header">
            <%= AppointmentNote::NOTE_TYPES[note_type] || note_type.humanize %>
            <span class="badge bg-secondary"><%= notes.count %></span>
          </h5>
          
          <div class="notes-list">
            <% notes.each do |note| %>
              <div class="note-item card mb-2 <%= note.priority_class %>">
                <div class="card-body">
                  <div class="note-header d-flex justify-content-between align-items-start">
                    <div>
                      <% if note.title.present? %>
                        <h6 class="note-title"><%= note.title %></h6>
                      <% end %>
                      <small class="text-muted">
                        <span class="priority-badge badge bg-<%= note.priority == 3 ? 'danger' : note.priority == 2 ? 'warning' : 'secondary' %>">
                          <%= note.priority_label %> Priority
                        </span>
                        â€¢ Created <%= note.created_at.strftime("%b %d, %Y at %I:%M %p") %>
                        <% if note.created_by %>
                          by <%= note.created_by.email %>
                        <% end %>
                      </small>
                    </div>
                    
                    <% if user_signed_in? %>
                        <%= link_to remove_note_appointment_path(@appointment, note_id: note.id), 
                                    method: :delete, 
                                    class: "btn btn-sm btn-outline-danger",
                                    data: { confirm: "Are you sure you want to delete this note?" } do %>
                            <i class="fas fa-trash"></i>
                        <% end %>
                    <% end %>
                  </div>
                  
                  <div class="note-content mt-2">
                    <%= simple_format(note.content) %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="no-notes text-center text-muted py-4">
        <i class="fas fa-sticky-note fa-3x mb-3"></i>
        <p>No internal notes have been added yet.</p>
        <small>Add notes to share important information with your team about this appointment.</small>
      </div>
    <% end %>
  </div>
</div>

<style>
  .priority-high { border-left: 4px solid #dc3545; }
  .priority-medium { border-left: 4px solid #ffc107; }
  .priority-low { border-left: 4px solid #6c757d; }
  
  .note-type-header {
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .appointment-notes-section {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
  }
</style>