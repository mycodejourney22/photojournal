<!-- app/views/expense_reports/index.html.erb -->
<div class="g-content__toolbar">
  <div class="g-content__page-title">
    <h1>Expense Reports</h1>
  </div>
  <div class="g-content__toolbar-actions">
    <%= link_to expense_reports_path(format: :csv, start_date: @start_date, end_date: @end_date, location: params[:location], category: params[:category]),
                class: "g-button g-button--action" do %>
      <i class="fas fa-download"></i> Export CSV
    <% end %>
  </div>
</div>

<!-- Filters Section -->
<div class="analytics-filters">
  <%= form_with url: expense_reports_path, method: :get, local: true, class: "filters-form" do |f| %>
    <div class="filter-group">
      <div class="filter-item">
        <%= f.label :start_date, "Start Date", class: "filter-label" %>
        <%= f.date_field :start_date, value: @start_date, class: "filter-input", max: Date.today %>
      </div>

      <div class="filter-item">
        <%= f.label :end_date, "End Date", class: "filter-label" %>
        <%= f.date_field :end_date, value: @end_date, class: "filter-input", max: Date.today %>
      </div>

      <div class="filter-item">
        <%= f.label :location, "Location", class: "filter-label" %>
        <%= f.select :location,
                    ['All Locations'] + @available_locations,
                    { selected: params[:location] || 'All Locations' },
                    class: "filter-input" %>
      </div>

      <div class="filter-item">
        <%= f.label :category, "Category", class: "filter-label" %>
        <%= f.select :category,
                    ['All Categories'] + @available_categories,
                    { selected: params[:category] || 'All Categories' },
                    class: "filter-input" %>
      </div>

      <%= f.submit "Apply Filters", class: "filter-button" %>
      <%= link_to "Reset", expense_reports_path, class: "reset-button" %>

      <div class="filter-presets">
        <%= link_to "Today", expense_reports_path(start_date: Date.today, end_date: Date.today), class: "preset-link" %>
        <%= link_to "Last 7 Days", expense_reports_path(start_date: 7.days.ago.to_date, end_date: Date.today), class: "preset-link" %>
        <%= link_to "Last 30 Days", expense_reports_path(start_date: 30.days.ago.to_date, end_date: Date.today), class: "preset-link" %>
        <%= link_to "This Month", expense_reports_path(start_date: Date.today.beginning_of_month, end_date: Date.today), class: "preset-link" %>
        <%= link_to "Last Month", expense_reports_path(start_date: 1.month.ago.beginning_of_month, end_date: 1.month.ago.end_of_month), class: "preset-link" %>
      </div>
    </div>
  <% end %>

  <div class="filter-info">
    <p>
      Showing data from <strong><%= @start_date.strftime("%B %d, %Y") %></strong> to <strong><%= @end_date.strftime("%B %d, %Y") %></strong>
      <% if @selected_location %>
        for <strong><%= @selected_location %></strong> location
      <% else %>
        for <strong>all locations</strong>
      <% end %>
      <% if @selected_category %>
        • <strong><%= @selected_category %></strong> category only
      <% end %>
    </p>
  </div>
</div>

<!-- Summary Metrics -->
<div class="analytics-overview">
  <div class="metric-card metric-card--expense">
    <div class="metric-value"><%= number_to_currency(@total_expenses, unit: "₦", precision: 0) %></div>
    <div class="metric-label">Total Expenses</div>
    <div class="metric-description">Total amount spent in period</div>
  </div>

  <div class="metric-card">
    <div class="metric-value"><%= @expense_count %></div>
    <div class="metric-label">Total Transactions</div>
    <div class="metric-description">Number of expense entries</div>
  </div>

  <div class="metric-card">
    <div class="metric-value"><%= number_to_currency(@average_expense, unit: "₦", precision: 0) %></div>
    <div class="metric-label">Average Expense</div>
    <div class="metric-description">Per transaction</div>
  </div>

  <div class="metric-card">
    <div class="metric-value metric-value--small"><%= @top_category %></div>
    <div class="metric-label">Top Category</div>
    <div class="metric-description">Highest spending category</div>
  </div>

  <div class="metric-card">
    <div class="metric-value" style="color: <%= @period_change <= 0 ? '#0F9D58' : '#DB4437' %>;">
      <%= @period_change > 0 ? '+' : '' %><%= @period_change %>%
    </div>
    <div class="metric-label">vs Last Period</div>
    <div class="metric-description">Period over period change</div>
  </div>
</div>

<!-- Charts Section -->
<div class="analytics-charts" data-controller="expense-reports-chart">
  <div class="analytics-card chart-card">
    <div class="analytics-card-header">
      <h2>Daily Expenses Trend</h2>
    </div>
    <div class="chart-container">
      <canvas data-expense-reports-chart-target="dailyExpensesChart"
              data-chart-data="<%= @daily_expenses_chart_data.to_json %>"></canvas>
    </div>
  </div>

  <div class="analytics-card chart-card">
    <div class="analytics-card-header">
      <h2>Expenses by Category</h2>
    </div>
    <div class="chart-container">
      <canvas data-expense-reports-chart-target="categoryChart"
              data-chart-data="<%= @category_chart_data.to_json %>"></canvas>
    </div>
  </div>
</div>

<!-- Breakdown Tables -->
<div class="analytics-charts">
  <!-- Location Breakdown -->
  <div class="analytics-card">
    <div class="analytics-card-header">
      <h2>Expenses by Location</h2>
    </div>
    <div class="analytics-table-wrapper">
      <table class="analytics-table">
        <thead>
          <tr>
            <th>Location</th>
            <th style="text-align: right;">Total</th>
            <th style="text-align: center;">Count</th>
            <th style="text-align: center;">%</th>
          </tr>
        </thead>
        <tbody>
          <% if @location_breakdown.present? %>
            <% @location_breakdown.each do |item| %>
              <tr>
                <td class="location-cell"><%= item[:location] %></td>
                <td style="text-align: right; color: #d32f2f; font-weight: 600;">
                  <%= number_to_currency(item[:total], unit: "₦", precision: 0) %>
                </td>
                <td style="text-align: center;"><%= item[:count] %></td>
                <td style="text-align: center;">
                  <span class="percentage-badge"><%= item[:percentage] %>%</span>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr><td colspan="4" class="empty-state">No data available</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Category Breakdown -->
  <div class="analytics-card">
    <div class="analytics-card-header">
      <h2>Expenses by Category</h2>
    </div>
    <div class="analytics-table-wrapper">
      <table class="analytics-table">
        <thead>
          <tr>
            <th>Category</th>
            <th style="text-align: right;">Total</th>
            <th style="text-align: center;">Count</th>
            <th style="text-align: center;">%</th>
          </tr>
        </thead>
        <tbody>
          <% if @category_breakdown.any? %>
            <% @category_breakdown.each do |item| %>
              <tr>
                <td><%= item[:category] %></td>
                <td style="text-align: right; color: #d32f2f; font-weight: 600;">
                  <%= number_to_currency(item[:total], unit: "₦", precision: 0) %>
                </td>
                <td style="text-align: center;"><%= item[:count] %></td>
                <td style="text-align: center;">
                  <div class="progress-with-label">
                    <div class="progress-bar-mini">
                      <div class="progress-bar-fill" style="width: <%= item[:percentage] %>%;"></div>
                    </div>
                    <span class="progress-label"><%= item[:percentage] %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr><td colspan="4" class="empty-state">No data available</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Recent Expenses Table -->
<div class="analytics-card" style="margin-top: 20px;">
  <div class="analytics-card-header">
    <h2>Recent Expenses</h2>
    <%= link_to "View All →", expenses_path, class: "view-all-link" %>
  </div>
  <div class="analytics-table-wrapper">
    <table class="analytics-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th>Category</th>
          <th>Staff</th>
          <th style="text-align: right;">Amount</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody>
        <% if @recent_expenses.any? %>
          <% @recent_expenses.each do |expense| %>
            <tr>
              <td style="color: #666;"><%= expense.date.strftime("%b %d, %Y") %></td>
              <td style="font-weight: 500; color: #333;"><%= expense.description.capitalize %></td>
              <td>
                <span class="category-badge"><%= expense.category %></span>
              </td>
              <td><%= expense.staff_name %></td>
              <td style="text-align: right; color: #d32f2f; font-weight: 600;">
                <%= number_to_currency(expense.amount, unit: "₦", precision: 0) %>
              </td>
              <td><%= expense.location.capitalize %></td>
            </tr>
          <% end %>
        <% else %>
          <tr><td colspan="6" class="empty-state">No expenses recorded for this period</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<style>
  .analytics-filters {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    padding: 20px;
    margin-bottom: 20px;
  }

  .filters-form {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 15px;
  }

  .filter-group {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 15px;
    width: 100%;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
  }

  .filter-label {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 6px;
    color: #555;
  }

  .filter-input {
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    font-size: 14px;
    min-width: 180px;
  }

  .filter-button {
    background-color: #EDD400;
    color: #000;
    border: none;
    padding: 9px 16px;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-button:hover {
    background-color: #d9c000;
  }

  .reset-button {
    background-color: #f5f5f5;
    color: #333;
    border: none;
    padding: 9px 16px;
    border-radius: 5px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }

  .reset-button:hover {
    background-color: #e5e5e5;
  }

  .filter-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-left: auto;
  }

  .preset-link {
    font-size: 13px;
    color: #4285F4;
    text-decoration: none;
    padding: 5px 10px;
    border-radius: 4px;
    background-color: #f5f9ff;
    transition: all 0.2s;
  }

  .preset-link:hover {
    background-color: #e5efff;
  }

  .filter-info {
    margin-top: 15px;
    font-size: 14px;
    color: #555;
  }

  .analytics-overview {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }

  .metric-card {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    text-align: center;
    position: relative;
  }

  .metric-card--expense {
    border-left: 4px solid #d32f2f;
  }

  .metric-value {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #333;
  }

  .metric-value--small {
    font-size: 18px;
  }

  .metric-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
  }

  .metric-description {
    font-size: 12px;
    color: #666;
    line-height: 1.3;
  }

  .analytics-charts {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }

  .analytics-card {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    overflow: hidden;
  }

  .chart-card {
    min-height: 350px;
  }

  .analytics-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
  }

  .analytics-card-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    color: #333;
  }

  .view-all-link {
    font-size: 14px;
    color: #007bff;
    text-decoration: none;
  }

  .view-all-link:hover {
    text-decoration: underline;
  }

  .chart-container {
    padding: 20px;
    height: 300px;
    position: relative;
  }

  .analytics-table-wrapper {
    padding: 0;
    overflow-x: auto;
  }

  .analytics-table {
    width: 100%;
    border-collapse: collapse;
  }

  .analytics-table th {
    background-color: #f9f9f9;
    text-align: left;
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 600;
    color: #555;
    border-bottom: 1px solid #e0e0e0;
  }

  .analytics-table td {
    padding: 12px 20px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
    color: #333;
  }

  .location-cell {
    font-weight: 600;
  }

  .empty-state {
    text-align: center;
    color: #888;
    font-style: italic;
    padding: 40px;
  }

  .percentage-badge {
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }

  .category-badge {
    background-color: #f0f0f0;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    color: #555;
  }

  .progress-with-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .progress-bar-mini {
    width: 60px;
    height: 6px;
    background-color: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    border-radius: 3px;
    background-color: #d32f2f;
  }

  .progress-label {
    font-size: 12px;
    color: #666;
    min-width: 40px;
  }

  @media (max-width: 1400px) {
    .analytics-overview {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 1200px) {
    .analytics-overview {
      grid-template-columns: repeat(2, 1fr);
    }

    .analytics-charts {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .filter-group {
      flex-direction: column;
      align-items: flex-start;
    }

    .filter-presets {
      margin-left: 0;
      width: 100%;
      justify-content: flex-start;
    }

    .analytics-overview {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .metric-card {
      padding: 15px;
    }

    .metric-value {
      font-size: 24px;
    }

    .filter-item {
      min-width: 100%;
    }

    .filter-input {
      min-width: 100%;
    }
  }
</style>
